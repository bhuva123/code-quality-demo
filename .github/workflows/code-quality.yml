name: SpotBugs CLI with SARIF

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  spotbugs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build the project
        run: mvn clean package -DskipTests

      - name: Download SpotBugs CLI
        run: |
          curl -L -o spotbugs.zip https://github.com/spotbugs/spotbugs/releases/download/4.7.3/spotbugs-4.7.3.zip
          unzip spotbugs.zip
          mv spotbugs-* spotbugs

      - name: Download SARIF plugin
        run: |
          mkdir -p sarif
          curl -L -o sarif/spotbugs-sarif-plugin.jar https://repo1.maven.org/maven2/com/github/spotbugs/spotbugs-sarif-plugin/0.2.2/spotbugs-sarif-plugin-0.2.2.jar

      - name: Run SpotBugs and generate SARIF
        run: |
          mkdir -p reports
          find target -name "*.class" > classes.list
          ./spotbugs/bin/spotbugs -textui -pluginList sarif/spotbugs-sarif-plugin.jar \
            -sarifOutput reports/spotbugs.sarif \
            -effort:max -low -projectName MyProject \
            @classes.list

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/spotbugs.sarif
