name: PMD and SpotBugs Lint

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  security-events: write

jobs:
  java-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # ---------------------
      # PMD SETUP & EXECUTION
      # ---------------------
      - name: Install PMD 7.12.0
        run: |
          cd $HOME
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.12.0/pmd-dist-7.12.0-bin.zip
          unzip -q pmd-dist-7.12.0-bin.zip

      - name: Run PMD
        run: |
          mkdir -p reports/pmd
          $HOME/pmd-bin-7.12.0/bin/pmd check \
            -d ./src \
            -R rulesets/java/quickstart.xml \
            -f text > reports/pmd/pmd-report.txt

      # -------------------------
      # SPOTBUGS SETUP & EXECUTION
      # -------------------------
      - name: Install SpotBugs 4.8.3
        run: |
          cd $HOME
          wget https://github.com/spotbugs/spotbugs/releases/download/4.8.3/spotbugs-4.8.3.tgz
          tar -xzf spotbugs-4.8.3.tgz

      - name: Compile Java code
        run: |
          mkdir -p target/classes
          find src -name "*.java" > sources.txt
          javac -d target/classes @sources.txt

      - name: Run SpotBugs with SARIF output
        run: |
          mkdir -p reports/spotbugs
          $HOME/spotbugs-4.8.3/bin/spotbugs \
            -textui \
            -sarif:reports/spotbugs/spotbugs.sarif \
            -effort:max \
            -low \
            target/classes

      - name: Upload PMD text report
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: reports/pmd/pmd-report.txt

      - name: Upload SpotBugs SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: reports/spotbugs/spotbugs.sarif
          category: spotbugs

      - name: Upload SpotBugs report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: reports/spotbugs/spotbugs.sarif
