name: PMD and SpotBugs Lint

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  security-events: write

jobs:
  pmd_lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PMD
        run: |
          sudo apt-get update && sudo apt-get install unzip -y
          curl -L https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.42.0/pmd-bin-6.42.0.zip -o pmd.zip
          unzip -o pmd.zip -d pmd-extracted
          echo "PMD_BIN_DIR=$(pwd)/pmd-extracted/pmd-bin-6.42.0/bin" >> $GITHUB_ENV

      - name: Run PMD and generate JSON
        continue-on-error: true
        run: |
          mkdir -p src || true
          bash $PMD_BIN_DIR/run.sh pmd \
            -d src \
            -f json \
            -R rulesets/java/quickstart.xml \
            --cache .pmdCache > pmd-report.json || true
          [ -s pmd-report.json ] || echo '{"files": []}' > pmd-report.json

      - name: Convert PMD JSON to SARIF
        run: |
          python3 - <<EOF
          import json
          with open("pmd-report.json") as f: data = json.load(f)
          sarif = {
              "version": "2.1.0",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "PMD",
                          "informationUri": "https://pmd.github.io/",
                          "rules": []
                      }
                  },
                  "results": [
                      {
                          "ruleId": v["rule"],
                          "message": {"text": v["description"]},
                          "locations": [{
                              "physicalLocation": {
                                  "artifactLocation": {"uri": f["filename"]},
                                  "region": {"startLine": v["beginline"]}
                              }
                          }]
                      } for f in data.get("files", []) for v in f.get("violations", [])
                  ]
              }]
          }
          with open("pmd-report.sarif", "w") as f: json.dump(sarif, f, indent=2)
          EOF

      - name: Upload PMD SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pmd-report.sarif
          category: pmd

      - name: Show PMD Summary
        if: always()
        continue-on-error: true
        run: |
          echo "## ðŸ“Œ PMD Issues" >> $GITHUB_STEP_SUMMARY
          echo "| File | Line | Rule | Message |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|---------|" >> $GITHUB_STEP_SUMMARY
          if [ -s pmd-report.json ]; then
            jq -c '.files[] | .filename as $f | .violations[] | {file: $f, line: .beginline, rule: .rule, message: .description}' pmd-report.json | while read -r line; do
              file=$(echo "$line" | jq -r '.file')
              line_num=$(echo "$line" | jq -r '.line')
              rule=$(echo "$line" | jq -r '.rule')
              msg=$(echo "$line" | jq -r '.message' | sed 's/|/\\|/g')
              echo "| $file | $line_num | $rule | $msg |" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "| - | - | - | No issues found |" >> $GITHUB_STEP_SUMMARY
          fi

  spotbugs_lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Install SpotBugs and SARIF plugin
        run: |
          curl -L https://github.com/spotbugs/spotbugs/releases/download/4.8.3/spotbugs-4.8.3.tgz -o spotbugs.tgz
          tar -xzf spotbugs.tgz
          mkdir -p spotbugs-4.8.3/plugin
          curl -L https://github.com/spotbugs/spotbugs-sarif/releases/latest/download/spotbugs-sarif.jar -o spotbugs-4.8.3/plugin/spotbugs-sarif.jar

      - name: Ensure source and target folders exist
        run: |
          mkdir -p src/test/java/test
          mkdir -p target/classes

      - name: Add Java file with known issue (test)
        run: |
          cat <<EOF > src/test/java/test/DeadStoreExample.java
          package test;
          public class DeadStoreExample {
              public static void main(String[] args) {
                  int x = 42; // dead store
                  System.out.println("Hello");
              }
          }
          EOF

      - name: Compile Java source
        continue-on-error: true
        run: |
          find src -type f -name "*.java" > java_files.txt
          if [ -s java_files.txt ]; then
            javac -d target/classes $(cat java_files.txt)
          else
            echo "No Java files found to compile"
          fi

      - name: Run SpotBugs and generate SARIF
        run: |
          mkdir -p reports/spotbugs
          chmod +x ./spotbugs-4.8.3/bin/spotbugs
          ./spotbugs-4.8.3/bin/spotbugs \
            -textui \
            -pluginList spotbugs-4.8.3/plugin/spotbugs-sarif.jar \
            -sarif:reports/spotbugs/spotbugs.sarif \
            -effort:max \
            -low \
            target/classes || echo "âš ï¸ SpotBugs returned non-zero exit"

          if [ ! -f reports/spotbugs/spotbugs.sarif ]; then
            echo '{"version": "2.1.0", "runs": [{"tool": {"driver": {"name": "SpotBugs"}}, "results": []}]}' > reports/spotbugs/spotbugs.sarif
          fi

      - name: Upload SpotBugs SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/spotbugs/spotbugs.sarif
          category: spotbugs

      - name: SpotBugs Summary
        if: always()
        run: |
          echo "## ðŸž SpotBugs Issues" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/spotbugs/spotbugs.sarif ]; then
            count=$(jq '.runs[0].results | length' reports/spotbugs/spotbugs.sarif)
            echo "Found $count issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "No SARIF file found." >> $GITHUB_STEP_SUMMARY
          fi
