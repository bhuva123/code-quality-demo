name: Java Linting with PMD and SpotBugs

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  security-events: write
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Install PMD
        run: |
          curl -sL https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.12.0/pmd-dist-7.12.0-bin.zip -o pmd.zip
          unzip -q pmd.zip -d pmd
          echo "PMD installed"

      - name: Run PMD
        run: |
          mkdir -p reports/pmd
          pmd/pmd-bin-7.0.0-rc4/bin/pmd check \
            --dir src/ \
            --rulesets category/java/bestpractices.xml \
            --format sarif > reports/pmd/pmd.sarif
          echo "PMD SARIF report generated"

      - name: Upload PMD SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: reports/pmd/pmd.sarif
          category: pmd

      - name: Install SpotBugs
        run: |
          curl -sL https://github.com/spotbugs/spotbugs/releases/latest/download/spotbugs-4.8.3.zip -o spotbugs.zip
          unzip -q spotbugs.zip -d spotbugs
          echo "SpotBugs installed"

      - name: Compile Java code
        run: |
          mkdir -p target/classes
          javac -d target/classes $(find src -name "*.java")

      - name: Run SpotBugs
        run: |
          mkdir -p reports/spotbugs
          spotbugs/spotbugs-4.8.3/bin/spotbugs \
            -textui \
            -sarif:reports/spotbugs/spotbugs.sarif \
            -low \
            -effort:max \
            target/classes
          echo "SpotBugs SARIF report generated"

      - name: Upload SpotBugs SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: reports/spotbugs/spotbugs.sarif
          category: spotbugs

      - name: Upload reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: reports/
