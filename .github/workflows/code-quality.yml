name: Java Linting with PMD and SpotBugs

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master]

permissions:
  security-events: write  # Needed for uploading SARIF to GitHub
  actions: read
  contents: read

jobs:
  lint:
    name: Lint with PMD and SpotBugs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build project with Maven (skip tests)
        run: mvn clean compile -DskipTests

      - name: Run PMD
        run: |
          mvn pmd:pmd pmd:aggregate -Dformat=sarif
          mkdir -p reports/pmd
          cp target/site/pmd.xml reports/pmd/
          cp target/site/pmd.sarif reports/pmd/

      - name: Upload PMD SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: reports/pmd/pmd.sarif
          category: pmd

      - name: Run SpotBugs
        run: |
          mvn com.github.spotbugs:spotbugs-maven-plugin:4.7.3.0:spotbugs \
              com.github.spotbugs:spotbugs-maven-plugin:4.7.3.0:spotbugs-report \
              -Dspotbugs.sarifOutput=true
          mkdir -p reports/spotbugs
          cp target/spotbugsXml.xml reports/spotbugs/
          cp target/spotbugs.sarif reports/spotbugs/

      - name: Upload SpotBugs SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: reports/spotbugs/spotbugs.sarif
          category: spotbugs

      - name: Upload PMD & SpotBugs reports as artifact
        uses: actions/upload-artifact@v3
        with:
          name: lint-reports
          path: reports/
